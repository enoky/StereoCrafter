# Merging GUI User Guide

The Merging GUI is a tool designed to take the outputs from the inpainting process and blend them into a final, high-quality stereoscopic video. It combines the original left-eye view with a newly created right-eye view, using a mask to seamlessly blend the inpainted areas.

## Main Interface

The interface is divided into several key sections:

### 1. Folders

This is where you specify the locations of your source and output files.

-   **Inpainted Video Folder:** The folder containing your right-eye videos generated by the Inpainting GUI (e.g., `*_inpainted_right_eye.mp4` or `*_inpainted_sbs.mp4`).
-   **Original Video Folder:** The folder with the original 2D source videos. This is required to provide the left-eye view for the final stereo video.
-   **Mask Folder:** The folder containing the high-resolution splatted files (e.g., `*_splatted4.mp4`). These files contain the mask that defines the blend area.
-   **Output Folder:** The destination where your final merged videos will be saved.

### 2. Live Preview

This section allows you to see a real-time preview of your blending settings on a single frame before starting a batch process.

-   **Preview Window:** Displays the output image. It's scrollable if the preview size is larger than the window.
-   **Frame Scrubber:** A slider to select which frame of the video you want to preview.
-   **Preview Source:** A dropdown menu to view different layers of the composition for diagnostics (e.g., just the mask, the original left eye, or the final blended image).
-   **Load/Refresh List:** On the first click, scans the folder for all video files. Subsequent clicks refresh the preview without rescanning (faster). If folder paths change, the next click will scan again.
-   **Prev / Next / Jump to:** Buttons to navigate between the videos found in your inpainted folder.
-   **Preview Source:** Dropdown to view different layers of the composition. Your selection is saved and restored on the next session.

### 3. Mask Processing Parameters

These sliders give you fine-grained control over how the mask is processed before it's used for blending. Changes are reflected instantly in the Live Preview.

-   **Binarize Thresh:** Converts the grayscale mask into pure black and white. Set to a negative value to disable.
-   **Dilate Kernel:** Expands the mask to cover up thin black lines at the edges of the inpainted area.
-   **Blur Kernel:** Softens the edges of the mask for a more gradual, feathered blend.
-   **Shadow Parameters:** A set of sliders (`Shift`, `Gamma`, `Opacity`) that create a subtle, soft shadow effect on the mask to improve depth perception.

### 4. Options

-   **Use GPU for Mask Processing:** Uses the GPU for faster mask processing. Uncheck to use the CPU, which is slower but uses almost no VRAM.
-   **Output Format:** A dropdown menu to select the final 3D video format. Options include standard Full Side-by-Side (SBS), Half-SBS for compatibility, Double SBS (anamorphic for frame-packed displays), Cross-eye viewing, and Anaglyph for red/cyan glasses.
-   **Enable Color Transfer:** Corrects color shifts that may have been introduced by the inpainting model by matching the right eye's color palette to the original left eye.
-   **Pad to 16:9:** If your source video is not a standard 16:9 aspect ratio (e.g., a wide 2.35:1 movie), check this to add black bars (letterbox) to the output, making it a standard 16:9 video for better player compatibility.
-   **Add Borders:** If checked, applies borders from sidecar files (.fssidecar) to mask edge artifacts from the warping process. Borders are read from sidecars in the inpainted folder or original video folder.
-   **Resume:** If checked, moves successfully processed files to a `finished` subfolder after encoding and skips them on subsequent runs. Useful for resuming interrupted batch processing. Use "Restore Finished Files" in the File menu to move files back if needed.
-   **Preview Size:** Sets the maximum display size of the preview image. Larger values may impact UI performance.
-   **Batch Chunk Size:** The number of frames to process in memory at once. Lower this value if you run out of RAM on very long or high-resolution videos.

### 5. Progress and Controls

-   **Progress Bar:** Shows the progress of the overall batch operation.
-   **Status Label:** Displays the current status, such as which video is being processed or if an error has occurred.
-   **Borders Info:** Displays the border values read from sidecar files (e.g., "Borders: L=1.5%, R=2.8%").
-   **Start Blending:** Begins the batch processing for all found videos.
-   **Stop:** Halts the batch processing after the current video chunk is finished.
-   **Process Current Clip:** Processes only the currently selected clip in the preview. Useful for testing settings on a single video without processing the entire batch.

## Basic Workflow

1.  **Set Folders:** Fill in the paths for the `Inpainted`, `Original`, `Mask`, and `Output` folders.
2.  **Load Preview:** Click **Load/Refresh List** to load the first video.
3.  **Adjust Settings:** Use the **Frame Scrubber** to find a representative frame. Adjust the **Mask Processing Parameters** sliders until the blend in the preview window looks seamless.
4.  **Set Options:** Configure your output options (e.g., ensure `Use GPU` is checked and select your desired `Output Format`).
5.  **Start Processing:** Click **Start Blending** to process all videos in the batch.

## Menu Bar

-   **File Menu:** Allows you to load, save, and reset settings. You can also restore processed files from the "finished" subfolders back to the input folders for re-processing.
-   **Help Menu:** Contains an "About" dialog and a checkbox to **Enable Debug Logging**, which prints much more detailed information to the console for troubleshooting.

> **Tip:** Hover your mouse over any control to see a detailed tooltip explaining its function.

## Sidecar Files

The Merging GUI can read configuration from sidecar files (.fssidecar) to automatically apply settings:

-   **Sidecar Location:** Sidecars are looked for in:
    1.  The inpainted video folder (checked first)
    2.  The original video folder
    3.  Next to the inpainted video file (e.g., `video.fssidecar` next to `video.mp4`)

-   **Sidecar Format:** JSON files with `.fssidecar` extension containing:
    -   `left_border`: Left border percentage (e.g., 1.5)
    -   `right_border`: Right border percentage (e.g., 2.8)
    -   `convergence_plane`: Convergence plane value
    -   `max_disparity`: Maximum disparity value

-   **Borders:** When "Add Borders" is enabled, borders from the sidecar are applied to zero out edge pixels that may contain artifacts from the warping process.

> **Tip:** Enable "Enable Debug Logging" in the Help menu to see which sidecar files are being loaded and their values.
